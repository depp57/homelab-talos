version: 1
metadata:
  name: Sources - Google
entries:
  - id: google_source
    model: authentik_sources_oauth.oauthsource
    identifiers:
      name: source/google
    attrs:
      enabled: true
      name: Google
      slug: google
      provider_type: google

      access_token_url: https://oauth2.googleapis.com/token
      authorization_code_auth_method: basic_auth
      authorization_url: https://accounts.google.com/o/oauth2/v2/auth
      group_matching_mode: identifier
      user_matching_mode: identifier
      user_path_template: goauthentik.io/sources/%(slug)s

      consumer_key: !Env BLUEPRINT_SOURCES_GOOGLE_CONSUMER_KEY
      consumer_secret: !Env BLUEPRINT_SOURCES_GOOGLE_CONSUMER_SECRET

      enrollment_flow:
        !Find [
          authentik_flows.flow,
          [ slug, "default-source-enrollment" ],
        ]

      authentication_flow:
        !Find [
          authentik_flows.flow,
          [ slug, "default-source-authentication" ],
        ]

  # Bind the Google email address as a username in Authentik
  - id: google_policy_email_to_username
    model: authentik_policies_expression.expressionpolicy
    identifiers:
      name: expressionPolicy/bind-email-to-username
    attrs:
      expression: |
        email = request.context["prompt_data"]["email"]
        request.context["prompt_data"]["username"] = email
        return False

  - id: google_policy_binding_email_to_username
    model: authentik_policies.policybinding
    identifiers:
      order: 0
      policy: !KeyOf "google_policy_email_to_username"
      target: !Find [authentik_flows.flowstagebinding, [
        stage,
        !Find [authentik_stages_prompt.promptstage, [name, "default-source-enrollment-prompt"]]
      ]]
    attrs:
      enabled: true

  # Automatically assign myself as an infra-admin
  - id: google_policy_auto_assign_admin
    model: authentik_policies_expression.expressionpolicy
    identifiers:
      name: expressionPolicy/assign-myself-admin
    attrs:
      expression: |
        email = request.context["prompt_data"]["email"]
        if email == "deppdu5758@gmail.com":
          from authentik.core.models import Group
          group, _ = Group.objects.get_or_create(name="infra-admin")
          
          request.context["flow_plan"].context["groups"] = [group]
          
          return True

  - id: google_policy_binding_auto_assign_admin
    model: authentik_policies.policybinding
    identifiers:
      order: 0
      policy: !KeyOf "google_policy_auto_assign_admin"
      target: !Find [authentik_flows.flowstagebinding, [
        stage,
        !Find [authentik_stages_user_write.userwritestage, [name, "default-source-enrollment-write"]]
      ]]
    attrs:
      enabled: true
